# Montagu reverse proxy
A reverse proxy for Montagu. This allows us to expose a single port (443) and 
map different paths to different apps (containers).

## SSL configuration files
`nginx.montagu.conf` contains references to an SSL certificate, an SSL private key, and a DHE parameter, which it 
expects at `/etc/montagu/proxy/certificate.pem`, `/etc/montagu/proxy/ssl_key.pem` and 
`/etc/montagu/proxy/dhparam.pem`, respectively. SSL public certificates are stored
in the [montagu repository](https://github.com/vimc/montagu/tree/master/certs), the SSL private key and DHE parameter
files are stored in the vault and all 3 are copied into the running proxy container during deployment.

Secrets are stored in the vault at:

```
vault list secret/ssl/v2/support/key
```
and

```
vault list secret/ssl/v2/support/dhparam
```

### Generating new DHE parameters
The DHE parameter files in the vault were generated by running `openssl dhparam -out workspace/dhparam.pem 4096`

## Build and run locally
Run `./dev.sh`. Note that unless this is run in a constellation with the 
dependent services, ngnix will fail to start with `host not found in upstream "api"`.
I've been getting round this in development by just commenting out the config
relevant to the other services.

See also `./ci.sh` to see what else happens on TeamCity.