name: 'montagu'

x-logging: &log-journald
  driver: journald
  options:
    tag: montagu

services:
  api:
    image: ${ORG}/montagu-api:master
    ports:
     - "8080:8080"
    networks:
     - proxy
    depends_on:
     - db
    volumes:
     - token_key_volume:/etc/montagu/api/token_key
     - ${PWD}/montagu_emails:/tmp/montagu_emails

  # The stutter in the name is needed to match the constellation deployment,
  # which uses orderly-web as the container prefix, and web as the suffix.
  #orderly-web-web:
  #  image: ${ORG}/orderly-web:master
  #  networks:
  #   - proxy
  #  depends_on:
  #    - api
  #  volumes:
  #   - orderly_volume:/orderly
  packit:
    image: mrcide/packit:mrc-5140-support-montagu-redirect
    networks:
      - proxy
  packit-api:
    image: mrcide/packit-api:mrc-5140-support-montagu-redirect
    networks:
      - proxy
    depends_on:
      - packit-db
  packit-db:
    image: mrcide/packit-db:main
    networks:
      - proxy
  outpack_server:
    image: mrcide/outpack_server:main
    volumes:
      - ./../packit/demos/orderly:/outpack # This requires packit repo to be cloned in same dir as montagu-proxy!
    networks:
      - proxy
  db:
    image: ${ORG}/montagu-db:master
    ports:
     - "5432:5432"
    command: /etc/montagu/postgresql.test.conf
    networks:
     - proxy
 # orderly:
 #   image: ${ORG}/orderly.server:master
 #   volumes:
 #    - orderly_volume:/orderly
 #   command: --port 8321 --go-signal /orderly_go /orderly
 #   networks:
 #    - proxy
  contrib:
    image: ${ORG}/montagu-contrib-portal:master
    networks:
     - proxy
    depends_on:
     - api
    volumes:
     - template_volume:/usr/share/nginx/html/templates
     - guidance_volume:/usr/share/nginx/html/guidance
  admin:
    image: ${ORG}/montagu-admin-portal:master
    networks:
     - proxy
    depends_on:
     - api
volumes:
  template_volume:
  guidance_volume:
  token_key_volume:
networks:
  proxy:
